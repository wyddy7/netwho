# Story 21: Deep Link Onboarding

**Epic:** Epic 1 - The Gate (–í—Ö–æ–¥ –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å)
**Parent:** .cursor/tz/epic 1 The Gate.md
**Branch:** `feature/epic1-deep-link-onboarding`
**Prerequisites:** Story 20 (Schema & Access Control)

## Context
–†–µ–∞–ª–∏–∑—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Å—ã–ª–æ–∫ –≤–∏–¥–∞ `t.me/bot?start=join_<org_uuid>`. –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ª—é–¥–µ–π –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏. –ö–∞–º–∏–ª—å —Ä–∞–∑–¥–∞–µ—Ç QR-–∫–æ–¥/—Å—Å—ã–ª–∫—É, –ª—é–¥–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ—Ä–≥—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`.

## Technical Tasks

### 1. Onboarding Handler Update
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `app/handlers/onboarding.py`:
  - –í —Ñ—É–Ω–∫—Ü–∏–∏ `cmd_start()` –ø–∞—Ä—Å–∏—Ç—å `message.text` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `start` payload
  - –ï—Å–ª–∏ payload –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `join_` ‚Üí –∏–∑–≤–ª–µ—á—å UUID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
  - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å UUID (—Ñ–æ—Ä–º–∞—Ç, —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤ –ë–î)

### 2. User Service Extension
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `join_org(user_id: int, org_id: str) -> bool` –≤ `app/services/user_service.py`:
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
  - –ï—Å–ª–∏ –Ω–æ–≤—ã–π ‚Üí —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `organization_members` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
  - –ï—Å–ª–∏ —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `False` (–∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)

### 3. Repository Layer
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `app/repositories/contact_repo.py`:
  - –ú–µ—Ç–æ–¥ `add_member(user_id, org_id, status='pending')` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å ‚Üí –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å)

### 4. UX Flow
- [ ] –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
  - "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ [OrgName]! üéâ"
  - "–¢–≤–æ—è –∑–∞—è–≤–∫–∞ –Ω–∞ —É—á–∞—Å—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ü–æ–∫–∞ —Ç—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 3 –¥–µ–º–æ-–ø–æ–∏—Å–∫–∞."
  - "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç —Ç–≤–æ–π –¥–æ—Å—Ç—É–ø."

## Acceptance Criteria
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/start` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç payload `join_<uuid>`
- [ ] –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π: —Å–æ–∑–¥–∞–µ—Ç—Å—è —é–∑–µ—Ä ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—Ä–≥—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
- [ ] –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞—Ä—ã–π: –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—Ä–≥—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
- [ ] –ï—Å–ª–∏ —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫: –±–æ—Ç –ø–∏—à–µ—Ç "–¢—ã —É–∂–µ –≤ —ç—Ç–æ–π –æ—Ä–≥–µ"
- [ ] –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ—Ä–≥–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ ("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞")

## Files to Change
- `app/handlers/onboarding.py` (—Ñ—É–Ω–∫—Ü–∏—è `cmd_start`)
- `app/services/user_service.py` (–º–µ—Ç–æ–¥ `join_org`)
- `app/repositories/contact_repo.py` (–º–µ—Ç–æ–¥ `add_member` —Å —É—á–µ—Ç–æ–º —Å—Ç–∞—Ç—É—Å–∞)

## Definition of Done
- [ ] –¢–µ—Å—Ç: `/start join_<valid_uuid>` –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ä–≥—É
- [ ] –¢–µ—Å—Ç: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `/start join_<same_uuid>` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "—É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫"
- [ ] –¢–µ—Å—Ç: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π UUID –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–æ—à–∏–±–∫–∞)
- [ ] –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ—Ä–≥–∏

**Estimated:** 2 —á–∞—Å–∞
